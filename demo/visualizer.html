<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Click Visualizer</title>
  <link rel="icon" href="data:,">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #viewport {
      position: relative;
      width: 1024px;
      height: 768px;
      border: 1px solid #ddd;
      margin-bottom: 10px;
      background: #fafafa;
      overflow: hidden;
    }
    .dot {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      opacity: 0.85;
      pointer-events: none;
      transform: translate(-50%, -50%);
    }
    #controls { margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2>Click Visualizer</h2>
  <div id="controls">
    Page path: <input id="page" type="text" value="/" style="width:200px" />
    Limit: <input id="limit" type="number" value="500" style="width:80px" />
    <button id="load">Load Events</button>
  </div>
  <div id="viewport"></div>
  <pre id="info"></pre>

<script>
const VIEW_W = 1024, VIEW_H = 768;
const API_URL = 'http://localhost:4000/api/v1/events';

async function loadEvents() {
  const page = document.getElementById('page').value.trim() || '/';
  const limit = parseInt(document.getElementById('limit').value, 10) || 500;

  try {
    const res = await fetch(`${API_URL}?page=${encodeURIComponent(page)}&limit=${limit}&_=${Date.now()}`);
    const { rows = [] } = await res.json();

    const vp = document.getElementById('viewport');
    vp.innerHTML = '';
    let clickCount = 0;

    rows.forEach(r => {
      if (r.event_type === 'click' && r.x != null && r.y != null) {
        clickCount++;
        const d = document.createElement('div');
        d.className = 'dot';

        // Color by recency (newer = redder)
        const hoursOld = (Date.now() - new Date(r.ts)) / 3_600_000;
        const hue = Math.max(0, Math.min(120, 120 - hoursOld * 10)); // fade to greenish as it gets older
        d.style.background = `hsl(${hue}, 80%, 50%)`;

        // Use absolute coordinates directly
        d.style.left = `${r.x}px`;
        d.style.top = `${r.y}px`;
        d.title = `${r.event_type} @ (${r.x},${r.y})`;
        vp.appendChild(d);
      }
    });

    document.getElementById('info').textContent =
      `Loaded ${rows.length} events, plotted ${clickCount} clicks.`;

  } catch (err) {
    document.getElementById('info').textContent = 'Error fetching events: ' + err.message;
    console.error('Error loading events:', err);
  }
}

document.getElementById('load').addEventListener('click', loadEvents);
</script>
</body>
</html>
